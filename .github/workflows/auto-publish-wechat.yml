name: Auto Publish WeChat Articles

concurrency:
  # å…è®¸åŒä¸€å¤©æ‰‹åŠ¨è¡¥å‘å¤šç¯‡ï¼Œä¸äº’ç›¸å–æ¶ˆï¼ˆPages éƒ¨ç½²ä»ä¼šåœ¨ GitHub ä¾§æ’é˜Ÿï¼‰
  group: auto-publish-${{ github.workflow }}
  cancel-in-progress: false

on:
  # å®šæ—¶è§¦å‘ï¼šæ¯å¤©å‘å¸ƒ 2 ç¯‡ï¼ˆåŒ—äº¬æ—¶é—´ 08:00 / 18:00ï¼‰
  schedule:
    # UTC: 00:00, 10:00  (CN: 08:00, 18:00)
    - cron: '0 0,10 * * *'

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      topic:
        description: 'æ–‡ç« ä¸»é¢˜ï¼ˆç•™ç©ºåˆ™ä½¿ç”¨é¢„è®¾ä¸»é¢˜ï¼‰'
        required: false
        type: string
        default: ''
      industry:
        description: 'è¡Œä¸šé€‰æ‹©'
        required: false
        type: choice
        default: 'technology'
        options:
          - technology
          - finance
          - healthcare
          - education
          - automotive
          - retail
          - manufacturing
      force_timestamp:
        description: 'å¼ºåˆ¶æ—¶é—´æˆ³ï¼ˆç”¨äºè¡¥å‘/å¤ç°ï¼Œä¾‹å¦‚ 20260203-080000ï¼›ç•™ç©ºåˆ™è‡ªåŠ¨ç”ŸæˆåŒ—äº¬æ—¶é—´æ—¶é—´æˆ³ï¼‰'
        required: false
        type: string
        default: ''

env:
  HUGO_VERSION: '0.155.1'
  BLOG_URL: 'https://gsaecy.github.io'

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: recursive
          fetch-depth: 0
      
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: ${{ env.HUGO_VERSION }}
          extended: true
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Determine article topic
        id: topic
        run: |
          echo "ğŸ¯ ç¡®å®šæ–‡ç« ä¸»é¢˜..."

          # schedule è§¦å‘æ—¶ github.event.inputs ä¸ºç©ºï¼Œè¿™é‡Œå…œåº•
          INDUSTRY="${{ github.event.inputs.industry }}"
          if [ -z "$INDUSTRY" ]; then
            # æ ¹æ®åŒ—äº¬æ—¶é—´é€‰æ‹©è¡Œä¸šï¼šæ—©ä¸Šåç§‘æŠ€ï¼Œæ™šä¸Šåé‡‘è/äº§ä¸š
            HOUR=$(TZ=Asia/Shanghai date +%H)
            DAY=$(TZ=Asia/Shanghai date +%d)
            if [ "$HOUR" -lt 12 ]; then
              INDUSTRY="technology"
            else
              # æ™šä¸Šåœ¨ finance/automotive ä¹‹é—´è½®æ¢
              if [ $((10#$DAY % 2)) -eq 0 ]; then
                INDUSTRY="finance"
              else
                INDUSTRY="automotive"
              fi
            fi
          fi

          # å¦‚æœæ‰‹åŠ¨æŒ‡å®šäº†ä¸»é¢˜
          if [ -n "${{ github.event.inputs.topic }}" ]; then
            TOPIC="${{ github.event.inputs.topic }}"
            echo "ä½¿ç”¨æ‰‹åŠ¨æŒ‡å®šä¸»é¢˜: $TOPIC"
          else
            case $INDUSTRY in
              technology) TOPIC="AIæŠ€æœ¯å‘å±•è¶‹åŠ¿ä¸è¡Œä¸šåº”ç”¨";;
              finance) TOPIC="æ•°å­—é‡‘èåˆ›æ–°ä¸é£é™©ç®¡ç†";;
              healthcare) TOPIC="æ™ºæ…§åŒ»ç–—æŠ€æœ¯çªç ´ä¸å¸‚åœºå‰æ™¯";;
              education) TOPIC="åœ¨çº¿æ•™è‚²æ¨¡å¼åˆ›æ–°ä¸æœªæ¥è¶‹åŠ¿";;
              automotive) TOPIC="æ–°èƒ½æºæ±½è½¦äº§ä¸šé“¾åˆ†æä¸æŠ•èµ„æœºä¼š";;
              retail) TOPIC="æ–°é›¶å”®æ•°å­—åŒ–è½¬å‹ä¸æ¶ˆè´¹è¶‹åŠ¿";;
              manufacturing) TOPIC="æ™ºèƒ½åˆ¶é€ æŠ€æœ¯å‡çº§ä¸äº§ä¸šå˜é©";;
              *) TOPIC="è¡Œä¸šæŠ€æœ¯å‘å±•è¶‹åŠ¿åˆ†æ";;
            esac
            echo "ä½¿ç”¨é¢„è®¾ä¸»é¢˜ [$INDUSTRY]: $TOPIC"
          fi

          FORCE_TS="${{ github.event.inputs.force_timestamp }}"
          if [ -n "$FORCE_TS" ]; then
            TIMESTAMP="$FORCE_TS"
          else
            # ç»Ÿä¸€ç”¨åŒ—äº¬æ—¶é—´ç”Ÿæˆæ—¶é—´æˆ³ï¼Œä¾¿äºå¯¹é½â€œ8ç‚¹/10ç‚¹â€è¿™ç§æ‰¿è¯º
            TIMESTAMP=$(TZ=Asia/Shanghai date +%Y%m%d-%H%M%S)
          fi

          # æ–‡ä»¶ååªç”¨è‹±æ–‡ï¼Œé¿å…ä¸­æ–‡ slug ä¸ºç©ºå¯¼è‡´è·¯å¾„å¼‚å¸¸
          FILENAME="${INDUSTRY}-${TIMESTAMP}"

          echo "industry=$INDUSTRY" >> $GITHUB_OUTPUT
          echo "topic=$TOPIC" >> $GITHUB_OUTPUT
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
      
      - name: Generate article (from top media)
        id: generate
        env:
          TOPIC: ${{ steps.topic.outputs.topic }}
          INDUSTRY: ${{ steps.topic.outputs.industry }}
          FILENAME: ${{ steps.topic.outputs.filename }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          echo "ğŸ—ï¸ é‡‡é›†è¡Œä¸šå¤´éƒ¨åª’ä½“RSSå¹¶ç”Ÿæˆæ–‡ç« ..."

          ORIGINAL_FILE="content/posts/${FILENAME}.md"
          WECHAT_FILE="content/posts/${FILENAME}-wechat.md"
          NEWS_JSON="data/raw/news_${FILENAME}.json"

          mkdir -p content/posts data/raw

          python3 scripts/collect_news.py --industry "${INDUSTRY}" --hours 24 --limit 25 --out "${NEWS_JSON}"

          # æ ‡é¢˜ï¼šå¿…é¡»åŒ…å«è¡Œä¸šï¼Œé¿å…è¯»è€…ä¸çŸ¥é“é»˜è®¤è¡Œä¸š
          CN_DATE=$(TZ=Asia/Shanghai date +%Y-%m-%d)
          case $INDUSTRY in
            technology) IND_CN="ç§‘æŠ€";;
            finance) IND_CN="é‡‘è";;
            healthcare) IND_CN="åŒ»ç–—";;
            education) IND_CN="æ•™è‚²";;
            automotive) IND_CN="æ±½è½¦";;
            retail) IND_CN="é›¶å”®";;
            manufacturing) IND_CN="åˆ¶é€ ";;
            *) IND_CN="$INDUSTRY";;
          esac

          TITLE="ã€${IND_CN}ã€‘${TOPIC}ï¼ˆ${CN_DATE}ï¼‰"

          python3 scripts/generate_news_post.py --in "${NEWS_JSON}" --slug "${FILENAME}" --industry "${INDUSTRY}" --title "${TITLE}" --out "${ORIGINAL_FILE}"

          # å¤åˆ¶ä¸€ä»½ç”¨äºå…¬ä¼—å·æ ¼å¼è½¬æ¢
          cp "${ORIGINAL_FILE}" "${WECHAT_FILE}"

          echo "âœ… æ–‡ç« å·²ç”Ÿæˆ: ${ORIGINAL_FILE}"
          echo "original_file=${ORIGINAL_FILE}" >> $GITHUB_OUTPUT
          echo "wechat_file=${WECHAT_FILE}" >> $GITHUB_OUTPUT
        shell: bash

      - name: Auto add charts (data-driven illustrations)
        run: |
          echo "æ ¹æ®è¡¨æ ¼æ•°æ®ç”Ÿæˆæ’å›¾ï¼ˆå›¾è¡¨ï¼‰..."
          ORIGINAL_FILE="${{ steps.generate.outputs.original_file }}"
          
          if [ -f "$ORIGINAL_FILE" ]; then
            python3 scripts/auto_illustrate.py "$ORIGINAL_FILE"
            echo "å·²ä¸ºæ–‡ç« ç”Ÿæˆå›¾è¡¨æ’å›¾å¹¶å†™å…¥ static/images"
          else
            echo "æœªæ‰¾åˆ°æ–‡ç« æ–‡ä»¶ï¼Œè·³è¿‡æ’å›¾ç”Ÿæˆ"
          fi

      - name: Auto add public images (Wikimedia Commons)
        run: |
          echo "ä»å…¬å¼€æ•°æ®æºè·å–é…å›¾ï¼ˆWikimedia Commonsï¼Œæ— éœ€API Keyï¼‰..."
          ORIGINAL_FILE="${{ steps.generate.outputs.original_file }}"
          
          if [ -f "$ORIGINAL_FILE" ]; then
            python3 scripts/auto_add_public_images.py "$ORIGINAL_FILE" || true
            echo "å·²å°è¯•ä¸ºæ–‡ç« æ’å…¥å…¬å¼€é…å›¾ï¼ˆå¹¶åœ¨æ–‡ä¸­å†™æ˜æ¥æºä¸è®¸å¯ï¼‰"
          else
            echo "æœªæ‰¾åˆ°æ–‡ç« æ–‡ä»¶ï¼Œè·³è¿‡å…¬å¼€é…å›¾"
          fi

      - name: Validate illustrations (non-blocking)
        run: |
          echo "æ ¡éªŒæ’å›¾è§„åˆ™ï¼šè‡³å°‘1å¼ å…¬å¼€é…å›¾ + æ¯ä¸ªå…³é”®è¡¨æ ¼1å¼ å›¾è¡¨..."
          ORIGINAL_FILE="${{ steps.generate.outputs.original_file }}"
          python3 scripts/validate_illustrations.py "$ORIGINAL_FILE" || echo "::warning::illustrations validation failed (will continue publishing)"

      - name: Record failure (commit to repo)
        if: failure()
        run: |
          echo "è®°å½•å¤±è´¥ä¿¡æ¯åˆ°ä»“åº“..."
          mkdir -p logs/auto-publish-failures
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          TS="$(date -u '+%Y-%m-%dT%H:%M:%SZ')"
          FILE="logs/auto-publish-failures/${{ github.run_id }}.md"
          {
            echo "# Auto Publish Failure";
            echo "";
            echo "- time(UTC): ${TS}";
            echo "- run: ${RUN_URL}";
            echo "- event: ${{ github.event_name }}";
            echo "- ref: ${{ github.ref }}";
            echo "";
            echo "This file is generated automatically when the workflow fails.";
          } > "$FILE"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$FILE" || true
          git commit -m "ğŸ§¾ è®°å½•è‡ªåŠ¨å‘å¸ƒå¤±è´¥ï¼šrun ${{ github.run_id }}" || true
          git push origin main || true

      - name: Notify Feishu (optional)
        if: failure()
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
        run: |
          if [ -z "$FEISHU_WEBHOOK_URL" ]; then
            echo "æœªé…ç½® FEISHU_WEBHOOK_URL secretï¼Œè·³è¿‡é£ä¹¦é€šçŸ¥"
            exit 0
          fi

          echo "å‘é€é£ä¹¦å¤±è´¥æé†’..."
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          TS="$(date '+%Y-%m-%d %H:%M:%S')"
          curl -sS -X POST "$FEISHU_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "{\"msg_type\":\"text\",\"content\":{\"text\":\"ã€åšå®¢è‡ªåŠ¨å‘å¸ƒå¤±è´¥ã€‘${TS}\\n${RUN_URL}\\nè¯·æŸ¥çœ‹å¤±è´¥æ­¥éª¤å¹¶é‡è¯•ã€‚\"}}" || true
      
      - name: Format for WeChat
        id: wechat
        run: |
          echo "è½¬æ¢ä¸ºå¾®ä¿¡å…¬ä¼—å·æ ¼å¼..."
          ORIGINAL_FILE="${{ steps.generate.outputs.original_file }}"

          if [ ! -f "$ORIGINAL_FILE" ]; then
            echo "æœªæ‰¾åˆ°æ–‡ç« æ–‡ä»¶ï¼Œæ— æ³•è½¬æ¢"
            exit 1
          fi

          # ç”Ÿæˆå…¬ä¼—å·æ’ç‰ˆæ–‡ä»¶ï¼ˆæ³¨æ„ï¼šä¸è¦è®©å®ƒå‚ä¸ Hugo æ„å»ºï¼Œå¦åˆ™ä¼šå¯¼è‡´åšå®¢å‡ºç°é‡å¤æ–‡ç« ï¼‰
          python3 format-wechat.py "$ORIGINAL_FILE"

          WECHAT_FILE="${ORIGINAL_FILE%.md}-wechat.md"
          if [ ! -f "$WECHAT_FILE" ]; then
            echo "å¾®ä¿¡å…¬ä¼—å·æ ¼å¼æ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi

          # å°†å…¬ä¼—å·æ–‡ä»¶ç§»å‡º content/postsï¼Œé¿å… Hugo ç”Ÿæˆç¬¬äºŒä¸ªåŒ slug é¡µé¢
          mkdir -p logs/wechat
          MOVED="logs/wechat/$(basename "$WECHAT_FILE")"
          mv "$WECHAT_FILE" "$MOVED"

          echo "å¾®ä¿¡å…¬ä¼—å·æ ¼å¼å·²ç”Ÿæˆ(ä¸å‘å¸ƒåˆ°åšå®¢): $MOVED"
          echo "wechat_file=$MOVED" >> $GITHUB_OUTPUT
      
      - name: Build Hugo site
        run: |
          echo "ğŸ—ï¸ æ„å»ºHugoç½‘ç«™..."
          hugo --minify
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'ğŸš€ è‡ªåŠ¨å‘å¸ƒæ–‡ç« : ${{ steps.topic.outputs.topic }} [$(date +%Y%m%d-%H%M%S)]'
      
      - name: Generate deployment report
        run: |
          echo "# è‡ªåŠ¨å‘å¸ƒæŠ¥å‘Š" > deployment-report.md
          echo "ç”Ÿæˆæ—¶é—´: $(date)" >> deployment-report.md
          echo "" >> deployment-report.md
          
          echo "## ğŸ“‹ å‘å¸ƒè¯¦æƒ…" >> deployment-report.md
          echo "- æ–‡ç« ä¸»é¢˜: ${{ steps.topic.outputs.topic }}" >> deployment-report.md
          echo "- ç”Ÿæˆæ—¶é—´: ${{ steps.topic.outputs.timestamp }}" >> deployment-report.md
          echo "- åŸå§‹æ–‡ç« : ${{ steps.generate.outputs.original_file }}" >> deployment-report.md
          echo "- å¾®ä¿¡å…¬ä¼—å·æ ¼å¼: ${{ steps.wechat.outputs.wechat_file }}" >> deployment-report.md
          echo "" >> deployment-report.md
          
          echo "## ğŸŒ è®¿é—®é“¾æ¥" >> deployment-report.md
          echo "- åšå®¢é¦–é¡µ: ${BLOG_URL}" >> deployment-report.md
          FILENAME="${{ steps.topic.outputs.filename }}"
          echo "- æ–‡ç« é¡µé¢: ${BLOG_URL}/posts/${FILENAME}/" >> deployment-report.md
          echo "" >> deployment-report.md
          
          echo "## â° ä¸‹æ¬¡å‘å¸ƒæ—¶é—´" >> deployment-report.md
          echo "ç³»ç»Ÿå°†åœ¨ä»¥ä¸‹æ—¶é—´è‡ªåŠ¨å‘å¸ƒæ–°æ–‡ç« ï¼š" >> deployment-report.md
          echo "- 08:00 (åŒ—äº¬æ—¶é—´)" >> deployment-report.md
          echo "- 18:00 (åŒ—äº¬æ—¶é—´)" >> deployment-report.md
          echo "" >> deployment-report.md
          
          echo "## ğŸ”§ æ‰‹åŠ¨è§¦å‘" >> deployment-report.md
          echo "å¦‚éœ€ç«‹å³å‘å¸ƒæ–‡ç« ï¼Œå¯åœ¨GitHub Actionsé¡µé¢æ‰‹åŠ¨è§¦å‘æ­¤å·¥ä½œæµã€‚" >> deployment-report.md
          
          cat deployment-report.md
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: published-articles
          path: |
            content/posts/*.md
            deployment-report.md
          retention-days: 7
      
      - name: Send success notification
        if: success()
        run: |
          echo "âœ… æ–‡ç« å‘å¸ƒæˆåŠŸï¼"
          echo "ä¸»é¢˜: ${{ steps.topic.outputs.topic }}"
          echo "æ—¶é—´: $(date)"
          echo "åšå®¢åœ°å€: ${BLOG_URL}"
          echo "æ–‡ç« é“¾æ¥: ${BLOG_URL}/posts/${{ steps.topic.outputs.filename }}/"