name: Daily AI Blog Automation

"on":
  # å·²åˆ‡æ¢åˆ° RSS èšåˆå‘å¸ƒæ¨¡å¼ï¼ˆauto-publish-wechat.ymlï¼‰ã€‚
  # æ­¤å·¥ä½œæµä¿ç•™ä»…ä¾›æ‰‹åŠ¨è§¦å‘/å›å½’æµ‹è¯•ã€‚
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'æµ‹è¯•æ¨¡å¼'
        required: false
        default: false
        type: boolean
      alarm_test:
        description: 'ä¸º true æ—¶ï¼šæ•…æ„å¤±è´¥å¹¶å‘é€é£ä¹¦å‘Šè­¦ï¼ˆç”¨äºè”é€šæµ‹è¯•ï¼‰'
        required: false
        default: false
        type: boolean

env:
  BLOG_URL: "https://gsaecy.github.io"
  PYTHON_VERSION: "3.11"

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  ai-automation:
    runs-on: ubuntu-latest
    outputs:
      article_generated: ${{ steps.run-automation.outputs.article_generated }}
      article_slug: ${{ steps.run-automation.outputs.article_slug }}
    
    steps:
      - name: Intentional failure (alarm test)
        id: alarm-fail
        if: ${{ inputs.alarm_test }}
        run: |
          echo "Intentional failure for Feishu alarm test"
          exit 1

      - name: Notify Feishu (app bot) (alarm test)
        if: ${{ always() && inputs.alarm_test }}
        env:
          FEISHU_APP_ID: ${{ secrets.FEISHU_APP_ID }}
          FEISHU_APP_SECRET: ${{ secrets.FEISHU_APP_SECRET }}
          FEISHU_ALERT_CHAT_ID: ${{ secrets.FEISHU_ALERT_CHAT_ID }}
        run: |
          # å·²ç¦ç”¨é£ä¹¦æœºå™¨äººé€šçŸ¥ï¼ˆç”¨æˆ·è¦æ±‚ï¼‰
          echo "é£ä¹¦æœºå™¨äººé€šçŸ¥å·²ç¦ç”¨"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pyyaml
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
      
      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          git config --global pull.rebase false
      
      - name: Run AI Automation System
        id: run-automation
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          echo "ğŸ¤– å¯åŠ¨AIè‡ªåŠ¨åŒ–åšå®¢ç³»ç»Ÿ..."
          echo ""
          
          # è¿è¡Œè‡ªåŠ¨åŒ–è„šæœ¬
          python scripts/simple_automation.py

          # å»é‡ï¼ˆé˜²æ­¢é‡å¤æ–‡ç« å¯¼è‡´æ„å»º/å±•ç¤ºå¼‚å¸¸ï¼‰
          python scripts/dedupe_posts.py || true
          
          # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†æ–°æ–‡ç« ï¼ˆæ”¾å®½çª—å£ï¼Œé¿å…runneræ—¶é—´æ¼‚ç§»/æ­¥éª¤è€—æ—¶ï¼‰
          NEW_POSTS=$(find content/posts -name "*.md" -mmin -30 2>/dev/null | head -1)
          
          if [ -n "$NEW_POSTS" ]; then
            echo "âœ… æ–°æ–‡ç« å·²ç”Ÿæˆ"
            SLUG=$(basename "$NEW_POSTS" .md)
            echo "article_generated=true" >> $GITHUB_OUTPUT
            echo "article_slug=$SLUG" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  æœªæ£€æµ‹åˆ°æ–°æ–‡ç« ç”Ÿæˆ"
            echo "article_generated=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit and push generated content
        if: steps.run-automation.outputs.article_generated == 'true'
        run: |
          echo "ğŸ’¾ æäº¤ç”Ÿæˆçš„å…§å®¹..."
          
          # æ·»åŠ æ‰€æœ‰æ›´æ”¹ï¼ˆå¼ºåˆ¶æ·»åŠ  logs ç›®å½•ï¼‰
          git add content/posts/ data/ logs/ -f
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --cached --quiet; then
            echo "ğŸ“ æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          else
            # æäº¤æ›´æ”¹
            TIMESTAMP=$(date +"%Y%m%d-%H%M%S")
            git commit -m "ğŸ¤– AIè‡ªåŠ¨ç”Ÿæˆæ–‡ç«  [${TIMESTAMP}]"
            
            # æ¨é€åˆ°ä»“åº“
            git push origin main
            echo "âœ… å†…å®¹å·²æäº¤å¹¶æ¨é€"
          fi
  
  hugo-deploy:
    needs: ai-automation
    if: needs.ai-automation.outputs.article_generated == 'true'
    
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
      
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: 'latest'
          extended: true
      
      - name: Build Hugo site
        run: |
          echo "ğŸ—ï¸ æ„å»ºHugoç½‘ç«™..."
          hugo --minify
          echo "âœ… æ„å»ºå®Œæˆ"
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
  
  monitor-deployment:
    needs: hugo-deploy
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Monitor deployment status
        run: |
          echo "ğŸ‘€ ç›‘æ§éƒ¨ç½²çŠ¶æ€..."
          echo ""
          
          if [ -n "${{ needs.ai-automation.outputs.article_slug }}" ]; then
            ARTICLE_URL="${{ env.BLOG_URL }}/posts/${{ needs.ai-automation.outputs.article_slug }}/"
            echo "ğŸ“ æ–‡ç« URL: ${ARTICLE_URL}"
            echo ""
            
            # ç­‰å¾…éƒ¨ç½²å®Œæˆ
            echo "ç­‰å¾…éƒ¨ç½²å®Œæˆï¼ˆæœ€å¤š10åˆ†é’Ÿï¼‰..."
            echo ""
            
            MAX_CHECKS=20
            CHECK_COUNT=0
            DEPLOYED=false
            
            while [ $CHECK_COUNT -lt $MAX_CHECKS ] && [ "$DEPLOYED" = "false" ]; do
              CHECK_COUNT=$((CHECK_COUNT + 1))
              echo "æ£€æŸ¥ #${CHECK_COUNT} - $(date '+%H:%M:%S')"
              
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${ARTICLE_URL}" 2>/dev/null || echo "000")
              
              if [ "$HTTP_CODE" = "200" ]; then
                echo "  ğŸ‰ æ–‡ç« å·²æˆåŠŸå‘å¸ƒï¼"
                echo "  ğŸ”— è®¿é—®é“¾æ¥: ${ARTICLE_URL}"
                DEPLOYED=true
              else
                echo "  â³ æ–‡ç« å°šæœªå‘å¸ƒ (HTTPçŠ¶æ€ç : ${HTTP_CODE})"
                
                # æ£€æŸ¥åšå®¢é¦–é¡µ
                if curl -s -f "${{ env.BLOG_URL }}" > /dev/null 2>&1; then
                  echo "  âœ… åšå®¢é¦–é¡µå¯è®¿é—®"
                fi
                
                if [ $CHECK_COUNT -lt $MAX_CHECKS ]; then
                  echo "  ç­‰å¾…30ç§’åé‡è¯•..."
                  sleep 30
                fi
              fi
            done
            
            if [ "$DEPLOYED" = "false" ]; then
              echo ""
              echo "âš ï¸  ç›‘æ§è¶…æ—¶ï¼šæ–‡ç« åœ¨10åˆ†é’Ÿå†…æœªå‘å¸ƒ"
              echo "å¯èƒ½çš„åŸå› ï¼š"
              echo "1. GitHub Pageséƒ¨ç½²å»¶è¿Ÿ"
              echo "2. Hugoæ„å»ºå¤±è´¥"
              echo "3. ç½‘ç»œé—®é¢˜"
              echo ""
              echo "è¯·æ‰‹åŠ¨æ£€æŸ¥ï¼š"
              echo "1. GitHub Actionsè¿è¡ŒçŠ¶æ€"
              echo "2. åšå®¢åœ°å€: ${{ env.BLOG_URL }}"
            fi
          else
            echo "ğŸ“ æœ¬æ¬¡è¿è¡Œæœªç”Ÿæˆæ–°æ–‡ç« "
            echo "åšå®¢åœ°å€: ${{ env.BLOG_URL }}"
          fi
  
  generate-report:
    needs: [ai-automation, hugo-deploy, monitor-deployment]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Generate automation report
        run: |
          echo "ğŸ“Š AIåšå®¢è‡ªåŠ¨åŒ–æ‰§è¡ŒæŠ¥å‘Š"
          echo "=========================="
          echo ""
          echo "ğŸƒ æ‰§è¡Œæ—¶é—´: $(date)"
          echo "ğŸ†” è¿è¡ŒID: ${{ github.run_id }}"
          echo "ğŸ¯ è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo ""
          
          echo "âœ… é˜¶æ®µæ‰§è¡Œç»“æœ:"
          echo "1. AIè‡ªåŠ¨åŒ–: ${{ needs.ai-automation.result == 'success' && 'âœ“ æˆåŠŸ' || 'âœ— å¤±è´¥' }}"
          
          if [ "${{ needs.ai-automation.outputs.article_generated }}" = "true" ]; then
            echo "   ç”Ÿæˆæ–‡ç« : âœ“ æ˜¯"
            echo "   æ–‡ç« slug: ${{ needs.ai-automation.outputs.article_slug }}"
          else
            echo "   ç”Ÿæˆæ–‡ç« : âœ— å¦"
          fi
          
          echo "2. Hugoéƒ¨ç½²: ${{ needs.hugo-deploy.result == 'success' && 'âœ“ æˆåŠŸ' || needs.hugo-deploy.result == 'skipped' && 'â¸ï¸ è·³è¿‡' || 'âœ— å¤±è´¥' }}"
          echo "3. éƒ¨ç½²ç›‘æ§: ${{ needs.monitor-deployment.result == 'success' && 'âœ“ å®Œæˆ' || needs.monitor-deployment.result == 'skipped' && 'â¸ï¸ è·³è¿‡' || 'âœ— å¤±è´¥' }}"
          echo ""
          
          echo "ğŸŒ åšå®¢çŠ¶æ€:"
          echo "åšå®¢åœ°å€: ${{ env.BLOG_URL }}"
          
          if [ "${{ needs.ai-automation.outputs.article_generated }}" = "true" ] && [ -n "${{ needs.ai-automation.outputs.article_slug }}" ]; then
            echo "æ–‡ç« é“¾æ¥: ${{ env.BLOG_URL }}/posts/${{ needs.ai-automation.outputs.article_slug }}/"
          fi
          echo ""
          
          echo "ğŸ“ˆ ç³»ç»ŸçŠ¶æ€:"
          echo "è‡ªåŠ¨åŒ–ç³»ç»Ÿ: âœ… è¿è¡Œæ­£å¸¸"
          echo "AIåˆ†æ: ${{ secrets.DEEPSEEK_API_KEY && 'âœ… APIå¯†é’¥å·²é…ç½®' || 'âš ï¸  ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®' }}"
          echo "éƒ¨ç½²æµæ°´çº¿: âœ… é…ç½®å®Œæˆ"
          echo ""
          
          echo "ğŸš€ ä¸‹ä¸€æ­¥å»ºè®®:"
          
          if [ "${{ needs.ai-automation.result }}" != "success" ]; then
            echo "1. ğŸ”§ æ£€æŸ¥AIè‡ªåŠ¨åŒ–è„šæœ¬"
            echo "2. ğŸ“ æŸ¥çœ‹è¯¦ç»†æ—¥å¿—"
          elif [ "${{ needs.ai-automation.outputs.article_generated }}" != "true" ]; then
            echo "1. ğŸ“Š æ£€æŸ¥æ•°æ®é‡‡é›†"
            echo "2. ğŸ¤– éªŒè¯AIåˆ†æé…ç½®"
          elif [ "${{ needs.hugo-deploy.result }}" != "success" ]; then
            echo "1. ğŸ—ï¸ æ£€æŸ¥Hugoæ„å»º"
            echo "2. ğŸŒ éªŒè¯GitHub Pagesé…ç½®"
          else
            echo "1. ğŸ‰ ç³»ç»Ÿè¿è¡Œæ­£å¸¸ï¼"
            echo "2. â° å®šæ—¶ä»»åŠ¡å·²å¯ç”¨ï¼ˆæ¯æ—¥10:00ï¼‰"
            echo "3. ğŸ”„ å¯æ‰‹åŠ¨è§¦å‘æµ‹è¯•"
          fi
          
          echo ""
          echo "---"
          echo "æŠ¥å‘Šç”Ÿæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ç³»ç»Ÿç‰ˆæœ¬: AIåšå®¢è‡ªåŠ¨åŒ– v1.0"