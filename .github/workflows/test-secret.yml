name: Test DeepSeek Secret

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'æµ‹è¯•ç±»åž‹'
        required: false
        default: 'simple'
        type: choice
        options:
          - simple
          - api

jobs:
  test-secret:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Test Secret Availability
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          echo "ðŸ” æµ‹è¯•GitHub Secret..."
          
          if [ -z "$DEEPSEEK_API_KEY" ]; then
            echo "âŒ é”™è¯¯: DEEPSEEK_API_KEYæœªè®¾ç½®æˆ–ä¸ºç©º"
            echo ""
            echo "è¯·è®¾ç½®GitHub Secret:"
            echo "1. ä½¿ç”¨GitHub CLI:"
            echo "   gh secret set DEEPSEEK_API_KEY --repo Gsaecy/Gsaecy.github.io --body \"ä½ çš„API Key\""
            echo ""
            echo "2. æˆ–åœ¨GitHubé¡µé¢:"
            echo "   è®¿é—®: https://github.com/Gsaecy/Gsaecy.github.io/settings/secrets/actions"
            echo "   ç‚¹å‡»'New repository secret'"
            echo "   åç§°: DEEPSEEK_API_KEY"
            echo "   å€¼: ä½ çš„DeepSeek API Key"
            exit 1
          fi
          
          echo "âœ… Secretå·²è®¾ç½®!"
          echo "   Keyé•¿åº¦: ${#DEEPSEEK_API_KEY} å­—ç¬¦"
          echo "   Keyå‰10ä½: ${DEEPSEEK_API_KEY:0:10}..."
          
          # ç®€å•éªŒè¯Keyæ ¼å¼
          if [[ "$DEEPSEEK_API_KEY" == sk-* ]]; then
            echo "âœ… Keyæ ¼å¼æ­£ç¡® (ä»¥'sk-'å¼€å¤´)"
          else
            echo "âš ï¸  Keyæ ¼å¼å¯èƒ½ä¸æ­£ç¡® (åº”è¯¥ä»¥'sk-'å¼€å¤´)"
          fi
      
      - name: Test DeepSeek API Connection
        if: github.event.inputs.test_type == 'api'
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          echo "æµ‹è¯•DeepSeek APIè¿žæŽ¥..."
          
          # å®‰è£…å¿…è¦çš„åŒ…
          pip install openai requests
          
          python -c "
import os, requests, json

api_key = os.getenv('DEEPSEEK_API_KEY')
if not api_key:
    print('âŒ æœªæ‰¾åˆ°API Key')
    exit(1)

print(f'ðŸ”‘ API Key: {api_key[:10]}...')
print('æµ‹è¯•APIè¿žæŽ¥...')

try:
    headers = {
        'Authorization': f'Bearer {api_key}',
        'Content-Type': 'application/json'
    }
    
    data = {
        'model': 'deepseek-chat',
        'messages': [{'role': 'user', 'content': 'è¯·å›žå¤"APIæµ‹è¯•æˆåŠŸ"'}],
        'max_tokens': 10
    }
    
    response = requests.post(
        'https://api.deepseek.com/chat/completions',
        headers=headers,
        json=data,
        timeout=10
    )
    
    if response.status_code == 200:
        result = response.json()
        print('âœ… APIè¿žæŽ¥æˆåŠŸ!')
        print(f'   å›žå¤: {result[\"choices\"][0][\"message\"][\"content\"]}')
        print(f'   ä½¿ç”¨token: {result[\"usage\"][\"total_tokens\"]}')
    else:
        print(f'âŒ APIè¯·æ±‚å¤±è´¥: {response.status_code}')
        print(f'   é”™è¯¯: {response.text}')
        
except Exception as e:
    print(f'âŒ æµ‹è¯•è¿‡ç¨‹å‡ºé”™: {e}')
          "
      
      - name: Generate Success Report
        if: success()
        run: |
          echo "ðŸŽ‰ DeepSeek Secretæµ‹è¯•æˆåŠŸ!" > report.md
          echo "==========================" >> report.md
          echo "" >> report.md
          echo "## æµ‹è¯•ç»“æžœ" >> report.md
          echo "- **SecretçŠ¶æ€**: âœ… å·²æ­£ç¡®è®¾ç½®" >> report.md
          echo "- **Keyæ ¼å¼**: éªŒè¯é€šè¿‡" >> report.md
          echo "- **æµ‹è¯•æ—¶é—´**: $(date)" >> report.md
          echo "" >> report.md
          echo "## ä¸‹ä¸€æ­¥" >> report.md
          echo "1. çŽ°åœ¨å¯ä»¥è¿è¡Œå®Œæ•´çš„å·¥ä½œæµ" >> report.md
          echo "2. è®¿é—®åšå®¢: https://gsaecy.github.io" >> report.md
          echo "3. æŸ¥çœ‹è¿è¡ŒçŠ¶æ€: https://github.com/Gsaecy/Gsaecy.github.io/actions" >> report.md
          
          cat report.md