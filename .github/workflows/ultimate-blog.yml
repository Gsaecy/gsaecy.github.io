name: Ultimate Blog Workflow

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'æ“ä½œç±»åž‹'
        required: false
        default: 'verify'
        type: choice
        options:
          - verify
          - publish
          - monitor

env:
  BLOG_URL: "https://gsaecy.github.io"
  TIMESTAMP: "$(date +%Y%m%d-%H%M%S)"

jobs:
  # ç¬¬ä¸€é˜¶æ®µï¼šéªŒè¯åŸºç¡€åŠŸèƒ½
  verify-basics:
    runs-on: ubuntu-latest
    outputs:
      secret_ok: ${{ steps.check-secret.outputs.ok }}
      git_ok: ${{ steps.check-git.outputs.ok }}
      hugo_ok: ${{ steps.check-hugo.outputs.ok }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: 1. Verify GitHub Secret
        id: check-secret
        env:
          API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          echo "ðŸ” éªŒè¯GitHub Secret..."
          if [ -n "$API_KEY" ]; then
            echo "âœ… Secretå­˜åœ¨"
            echo "é•¿åº¦: ${#API_KEY}"
            echo "æ ¼å¼: ${API_KEY:0:10}..."
            echo "ok=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Secretä¸å­˜åœ¨"
            echo "ok=false" >> $GITHUB_OUTPUT
          fi
      
      - name: 2. Verify Git Access
        id: check-git
        run: |
          echo "ðŸ“ éªŒè¯Gitè®¿é—®..."
          if git status > /dev/null 2>&1; then
            echo "âœ… Gitè®¿é—®æ­£å¸¸"
            echo "åˆ†æ”¯: $(git branch --show-current)"
            echo "ok=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Gitè®¿é—®å¤±è´¥"
            echo "ok=false" >> $GITHUB_OUTPUT
          fi
      
      - name: 3. Verify Hugo Setup
        id: check-hugo
        run: |
          echo "ðŸŽ¨ éªŒè¯Hugoé…ç½®..."
          if [ -f "hugo.toml" ] || [ -f "hugo.yml" ] || [ -f "config.toml" ]; then
            echo "âœ… Hugoé…ç½®æ–‡ä»¶å­˜åœ¨"
            echo "ok=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  æœªæ‰¾åˆ°Hugoé…ç½®æ–‡ä»¶"
            echo "ok=false" >> $GITHUB_OUTPUT
          fi

  # ç¬¬äºŒé˜¶æ®µï¼šç”Ÿæˆå†…å®¹
  generate-content:
    needs: verify-basics
    if: |
      needs.verify-basics.outputs.secret_ok == 'true' &&
      needs.verify-basics.outputs.git_ok == 'true' &&
      github.event.inputs.action != 'verify'
    
    runs-on: ubuntu-latest
    outputs:
      article_file: ${{ steps.generate.outputs.article_file }}
      article_slug: ${{ steps.generate.outputs.article_slug }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Generate Ultimate Article
        id: generate
        run: |
          echo "ðŸ“ ç”Ÿæˆç»ˆæžæµ‹è¯•æ–‡ç« ..."
          mkdir -p content/posts
          
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          SLUG="ultimate-${TIMESTAMP}"
          FILE="content/posts/${SLUG}.md"
          
          cat > "${FILE}" << 'EOF'
          ---
          title: "ç»ˆæžæµ‹è¯•æ–‡ç«  - ${TIMESTAMP}"
          date: $(date -Iseconds)
          draft: false
          tags: ["ç»ˆæž", "æµ‹è¯•", "éªŒè¯"]
          categories: ["ç³»ç»ŸéªŒè¯"]
          slug: "${SLUG}"
          ---
          
          # ðŸŽ¯ ç»ˆæžæµ‹è¯•éªŒè¯
          
          **æ—¶é—´æˆ³**: ${TIMESTAMP}
          **å·¥ä½œæµ**: Ultimate Blog Workflow
          **éªŒè¯é˜¶æ®µ**: å®Œæ•´æµç¨‹æµ‹è¯•
          
          ## âœ… å·²éªŒè¯åŠŸèƒ½
          1. GitHub Secretsè®¿é—® âœ“
          2. Gitä»“åº“è®¿é—® âœ“
          3. Hugoé…ç½®æ£€æŸ¥ âœ“
          4. æ–‡ç« ç”Ÿæˆ âœ“
          5. è‡ªåŠ¨æäº¤ âœ“
          6. éƒ¨ç½²è§¦å‘ âœ“
          
          ## ðŸ“Š ç³»ç»ŸçŠ¶æ€
          - **ç”Ÿæˆæ—¶é—´**: $(date)
          - **è¿è¡ŒID**: ${{ github.run_id }}
          - **æ“ä½œç±»åž‹**: ${{ github.event.inputs.action }}
          - **éªŒè¯ç»“æžœ**: è¿›è¡Œä¸­
          
          ## ðŸŽ¯ é¢„æœŸç»“æžœ
          è¿™ç¯‡æ–‡ç« åº”è¯¥ï¼š
          1. å‡ºçŽ°åœ¨åšå®¢æ–‡ç« ä¸­
          2. æ ¼å¼æ­£ç¡®æ˜¾ç¤º
          3. è¯æ˜Žç³»ç»Ÿå·¥ä½œæ­£å¸¸
          
          ---
          *ç»ˆæžéªŒè¯ç³»ç»Ÿ v1.0*
          *éªŒè¯ID: ${TIMESTAMP}*
          EOF
          
          echo "âœ… æ–‡ç« å·²ç”Ÿæˆ: ${FILE}"
          echo "article_file=${FILE}" >> $GITHUB_OUTPUT
          echo "article_slug=${SLUG}" >> $GITHUB_OUTPUT
      
      - name: Commit Generated Article
        run: |
          echo "ðŸ’¾ æäº¤æ–‡ç« åˆ°ä»“åº“..."
          git config --global user.name "Ultimate Workflow"
          git config --global user.email "ultimate@github.com"
          git add content/posts/
          git commit -m "ðŸŽ¯ ç»ˆæžæµ‹è¯•æ–‡ç«  [${TIMESTAMP}]"
          git push origin main
          
          echo "âœ… æ–‡ç« å·²æäº¤åˆ°GitHub"

  # ç¬¬ä¸‰é˜¶æ®µï¼šè§¦å‘éƒ¨ç½²
  trigger-deployment:
    needs: generate-content
    if: github.event.inputs.action == 'publish'
    
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Trigger Hugo Deployment
        run: |
          echo "ðŸš€ è§¦å‘Hugoéƒ¨ç½²..."
          echo "è¿™å°†è‡ªåŠ¨è¿è¡Œ hugo.yml å·¥ä½œæµ"
          echo ""
          echo "é¢„è®¡æ—¶é—´çº¿:"
          echo "1. ç«‹å³: Hugoæž„å»ºå¼€å§‹"
          echo "2. 1-2åˆ†é’Ÿ: æž„å»ºå®Œæˆ"
          echo "3. 2-3åˆ†é’Ÿ: éƒ¨ç½²åˆ°GitHub Pages"
          echo "4. 3-5åˆ†é’Ÿ: æ–‡ç« å¯è®¿é—®"
          
          # åˆ›å»ºç©ºæäº¤è§¦å‘éƒ¨ç½²
          git config --global user.name "Deployment Trigger"
          git config --global user.email "deploy@github.com"
          git commit --allow-empty -m "ðŸš€ è§¦å‘éƒ¨ç½² [ç»ˆæžæµ‹è¯• ${TIMESTAMP}]"
          git push origin main
          
          echo "âœ… éƒ¨ç½²å·²è§¦å‘"

  # ç¬¬å››é˜¶æ®µï¼šç›‘æŽ§ç»“æžœ
  monitor-results:
    needs: trigger-deployment
    if: github.event.inputs.action == 'publish'
    
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Monitor Deployment
        run: |
          echo "ðŸ‘€ ç›‘æŽ§éƒ¨ç½²ç»“æžœ..."
          echo "æ–‡ç« slug: ${{ needs.generate-content.outputs.article_slug }}"
          echo "é¢„æœŸURL: ${BLOG_URL}/posts/${{ needs.generate-content.outputs.article_slug }}/"
          echo ""
          echo "å¼€å§‹ç›‘æŽ§ï¼Œæ¯30ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œæœ€å¤š5åˆ†é’Ÿ..."
          echo ""
          
          MAX_CHECKS=10
          CHECK_COUNT=0
          PUBLISHED=false
          
          while [ $CHECK_COUNT -lt $MAX_CHECKS ] && [ "$PUBLISHED" = "false" ]; do
            CHECK_COUNT=$((CHECK_COUNT + 1))
            echo "æ£€æŸ¥ #${CHECK_COUNT} - $(date '+%H:%M:%S')"
            
            ARTICLE_URL="${BLOG_URL}/posts/${{ needs.generate-content.outputs.article_slug }}/"
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${ARTICLE_URL}" 2>/dev/null || echo "000")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "  ðŸŽ‰ æ–‡ç« å·²å‘å¸ƒ!"
              echo "  URL: ${ARTICLE_URL}"
              PUBLISHED=true
            else
              echo "  â³ æ–‡ç« å°šæœªå‘å¸ƒ (HTTP: ${HTTP_CODE})"
              
              # æ£€æŸ¥åšå®¢é¦–é¡µ
              if curl -s -f "${BLOG_URL}" > /dev/null 2>&1; then
                echo "  âœ… åšå®¢å¯è®¿é—®"
              fi
              
              if [ $CHECK_COUNT -lt $MAX_CHECKS ]; then
                echo "  ç­‰å¾…30ç§’..."
                sleep 30
              fi
            fi
          done
          
          if [ "$PUBLISHED" = "false" ]; then
            echo ""
            echo "âš ï¸  ç›‘æŽ§è¶…æ—¶: æ–‡ç« åœ¨5åˆ†é’Ÿå†…æœªå‘å¸ƒ"
            echo "å¯èƒ½çš„åŽŸå› :"
            echo "1. GitHub Pageséƒ¨ç½²å»¶è¿Ÿ"
            echo "2. Hugoæž„å»ºå¤±è´¥"
            echo "3. ç½‘ç»œé—®é¢˜"
          fi

  # ç¬¬äº”é˜¶æ®µï¼šç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
  final-report:
    needs:
      - verify-basics
      - generate-content
      - trigger-deployment
      - monitor-results
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Generate Ultimate Report
        run: |
          echo "ðŸŽ¯ ç»ˆæžå·¥ä½œæµéªŒè¯æŠ¥å‘Š"
          echo "======================"
          echo ""
          echo "ðŸ“Š è¿è¡Œä¿¡æ¯"
          echo "å·¥ä½œæµ: Ultimate Blog Workflow"
          echo "è¿è¡ŒID: ${{ github.run_id }}"
          echo "æ“ä½œç±»åž‹: ${{ github.event.inputs.action }}"
          echo "å¼€å§‹æ—¶é—´: ${{ github.event.workflow_run.created_at }}"
          echo "æŠ¥å‘Šæ—¶é—´: $(date)"
          echo ""
          
          echo "âœ… éªŒè¯ç»“æžœ"
          echo "1. GitHub Secret: ${{ needs.verify-basics.outputs.secret_ok == 'true' && 'âœ“ é€šè¿‡' || 'âœ— å¤±è´¥' }}"
          echo "2. Gitè®¿é—®: ${{ needs.verify-basics.outputs.git_ok == 'true' && 'âœ“ é€šè¿‡' || 'âœ— å¤±è´¥' }}"
          echo "3. Hugoé…ç½®: ${{ needs.verify-basics.outputs.hugo_ok == 'true' && 'âœ“ é€šè¿‡' || 'âœ— å¤±è´¥' }}"
          
          if [ "${{ github.event.inputs.action }}" != "verify" ]; then
            echo "4. æ–‡ç« ç”Ÿæˆ: ${{ needs.generate-content.result == 'success' && 'âœ“ å®Œæˆ' || 'âœ— å¤±è´¥' }}"
            
            if [ "${{ github.event.inputs.action }}" = "publish" ]; then
              echo "5. éƒ¨ç½²è§¦å‘: ${{ needs.trigger-deployment.result == 'success' && 'âœ“ å®Œæˆ' || 'âœ— å¤±è´¥' }}"
              echo "6. ç›‘æŽ§ç»“æžœ: ${{ needs.monitor-results.result == 'success' && 'âœ“ å®Œæˆ' || 'âš ï¸  è¶…æ—¶' }}"
            fi
          fi
          echo ""
          
          echo "â“ æ ¸å¿ƒé—®é¢˜ç­”æ¡ˆ"
          echo "æœ‰æ²¡æœ‰å‘å¸ƒæ–°æ–‡ç« ï¼Ÿ"
          
          if [ "${{ github.event.inputs.action }}" = "verify" ]; then
            echo "ðŸ” ç­”æ¡ˆ: ä»…éªŒè¯æ¨¡å¼ï¼Œæœªç”Ÿæˆæ–‡ç« "
          elif [ "${{ github.event.inputs.action }}" = "publish" ]; then
            if [ "${{ needs.monitor-results.result }}" = "success" ]; then
              echo "ðŸŽ‰ ç­”æ¡ˆ: âœ… æœ‰ï¼æ–‡ç« å·²æˆåŠŸå‘å¸ƒ"
              echo "æ–‡ç« URL: ${BLOG_URL}/posts/${{ needs.generate-content.outputs.article_slug }}/"
            else
              echo "âš ï¸  ç­”æ¡ˆ: éƒ¨ç½²è¿›è¡Œä¸­ï¼Œè¯·ç­‰å¾…æˆ–æ‰‹åŠ¨æ£€æŸ¥"
              echo "æ£€æŸ¥åšå®¢: ${BLOG_URL}"
            fi
          else
            echo "ðŸ“ ç­”æ¡ˆ: æ–‡ç« å·²ç”Ÿæˆå¹¶æäº¤ï¼Œç­‰å¾…éƒ¨ç½²"
          fi
          echo ""
          
          echo "ðŸ“‹ ä¸‹ä¸€æ­¥å»ºè®®"
          if [ "${{ needs.verify-basics.outputs.secret_ok }}" = "false" ]; then
            echo "1. âŒ ä¿®å¤GitHub Secreté…ç½®"
          elif [ "${{ github.event.inputs.action }}" = "verify" ]; then
            echo "1. âœ… åŸºç¡€éªŒè¯é€šè¿‡"
            echo "2. è¿è¡Œ publish æ¨¡å¼æµ‹è¯•å®Œæ•´æµç¨‹"
          elif [ "${{ github.event.inputs.action }}" = "publish" ] && [ "${{ needs.monitor-results.result }}" = "success" ]; then
            echo "1. ðŸŽ‰ ç³»ç»Ÿå®Œå…¨å·¥ä½œæ­£å¸¸!"
            echo "2. å¯ä»¥è®¾ç½®å®šæ—¶ä»»åŠ¡"
            echo "3. è€ƒè™‘å¯ç”¨ deepseek-secure.yml"
          else
            echo "1. ðŸ”§ éœ€è¦è¿›ä¸€æ­¥æŽ’æŸ¥"
            echo "2. æ£€æŸ¥Hugoéƒ¨ç½²å·¥ä½œæµ"
            echo "3. æŸ¥çœ‹GitHub PagesçŠ¶æ€"
          fi
          echo ""
          echo "---"
          echo "æŠ¥å‘ŠID: ULTIMATE-$(date +%Y%m%d-%H%M%S)"
          
      - name: Create Summary File
        run: |
          SUMMARY_FILE="ultimate-summary-$(date +%Y%m%d-%H%M%S).txt"
          
          echo "ç»ˆæžå·¥ä½œæµéªŒè¯æ‘˜è¦" > "${SUMMARY_FILE}"
          echo "ç”Ÿæˆæ—¶é—´: $(date)" >> "${SUMMARY_FILE}"
          echo "" >> "${SUMMARY_FILE}"
          
          if [ "${{ github.event.inputs.action }}" = "publish" ] && [ "${{ needs.monitor-results.result }}" = "success" ]; then
            echo "çŠ¶æ€: âœ… å®Œå…¨æˆåŠŸ" >> "${SUMMARY_FILE}"
            echo "æ–‡ç« : å·²å‘å¸ƒ" >> "${SUMMARY_FILE}"
            echo "URL: ${BLOG_URL}/posts/${{ needs.generate-content.outputs.article_slug }}/" >> "${SUMMARY_FILE}"
          else
            echo "çŠ¶æ€: ðŸ”§ éœ€è¦æ£€æŸ¥" >> "${SUMMARY_FILE}"
            echo "å»ºè®®: æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š" >> "${SUMMARY_FILE}"
          fi
          
          cat "${SUMMARY_FILE}"